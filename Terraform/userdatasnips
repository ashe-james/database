#  THIS FILE IS PURELY REFERENCE AND CONTAINS USERDATA SNIPPETS SPECIFIC TO ORACLE 12c
#  AND OPERATIONS REQUIRED TO TERRAFORM AN EXISTING SERVER

: '
#  disable transparent hugepages

sed -i '/GRUB_CMDLINE_LINUX/ s/\"$/ transparent_hugepage=never\"/g' /etc/default/grub
grub2-mkconfig -o /boot/grub2/grub.cfg
'


: '
#  disk i/o scheduling

echo "ACTION==\"add|change\", KERNEL==\"sd[b-z]\", ATTR{queue/rotational}==\"0\", ATTR{queue/scheduler}=\"deadline\"" > /etc/udev/rules.d/60-oracle-schedulers.rules
udevadm control --reload-rules
'


: '
#  swapfile

SWAP_MB=$( expr $( grep MemTotal /proc/meminfo | awk '{ print $2 }' ) / 976 )

if [[ $SWAP_MB -gt 16170 ]]; then
        SWAP_MB=16170
fi

dd if=/dev/zero of=/opt/swapfile bs=1MB count=$SWAP_MB
chmod 0600 /opt/swapfile
mkswap /opt/swapfile
swapon /opt/swapfile

sed -i.bu '/vg0-swap/d' /etc/fstab
echo "/opt/swapfile                                 swap                    swap    defaults        0 0" >> /etc/fstab
'


: '

         if [[ -f $GRID_HOME/root.sh ]]; then

        $GRID_HOME/bin/crsctl start res ora.cssd -init

        echo "GRID_HOME=$GRID_HOME" > /home/oracle/configureASM.sh
        echo "DB_HOME=$ORACLE_HOME" >> /home/oracle/configureASM.sh

echo '
$GRID_HOME/bin/srvctl add asm
$GRID_HOME/bin/srvctl start asm

echo "+ASM:$GRID_HOME:N" >> /etc/oratab

. /usr/local/bin/oraenv <<< +ASM

sqlplus /nolog <<EOF
connect / as sysasm
alter diskgroup DATA mount;
alter diskgroup FRA mount;
EOF

ASMSPFILE=$( asmcmd ls -t +DATA/ASM/ASMPARAMETERFILE | head -1 )
$GRID_HOME/bin/srvctl modify asm -diskstring "'"/dev/oracleasm/disks/*"'"
$GRID_HOME/bin/srvctl modify asm -pwfile "'"+DATA/orapwasm"'"
$GRID_HOME/bin/srvctl modify asm -spfile "'"+DATA/ASM/ASMPARAMETERFILE/\$ASMSPFILE"'"

DATABASES=$( asmcmd ls +FRA | sed "'"s/\///"'" | sort | tr "'"[:lower:]"'" "'"[:upper:]"'" )
DBARRAY=( $DATABASES )

for DB in "$${DBARRAY[@]}"; do
	DBSPFILE=$( asmcmd ls -t +DATA/$DB/PARAMETERFILE | head -1 )
	$GRID_HOME/bin/srvctl add database -db $DB -oraclehome $DB_HOME -spfile "'"+DATA/\$DB/PARAMETERFILE/\$DBSPFILE"'"
done

$GRID_HOME/bin/crsctl stop has -f
$GRID_HOME/bin/crsctl start has
' >> /home/oracle/configureASM.sh

        chmod +x /home/oracle/configureASM.sh
        su - oracle /home/oracle/configureASM.sh

        $GRID_HOME/bin/crsctl modify resource ora.asm -attr AUTO_START=always -unsupported

        fi
'


if [[ ! -f $ORACLE_HOME/dbs/osbws.ora && -f $ORACLE_HOME/root.sh ]]; then

        echo "ORACLE_HOME=$ORACLE_HOME" > /home/oracle/configureOSBWS.sh

echo '
IAMROLE=$( curl http://169.254.169.254/latest/meta-data/iam/security-credentials )

wget -P /home/oracle http://10.247.101.100/osbws_install.jar
java -jar osbws_install.jar -IAMRole $IAMROLE -libDir $ORACLE_HOME/lib/ -walletDir $ORACLE_HOME/dbs/ -configFile $ORACLE_HOME/dbs/osbws.ora -awsEndPoint s3.us-gov-west-1.amazonaws.com -location us-gov-west-1 -useHttps 
' >> /home/oracle/configureOSBWS.sh

        echo "echo \"OSB_WS_BUCKET=$RMAN_S3_BUCKET\" >> $ORACLE_HOME/dbs/osbws.ora" >> /home/oracle/configureOSBWS.sh

        chmod +x /home/oracle/configureOSBWS.sh
        su - oracle /home/oracle/configureOSBWS.sh

fi